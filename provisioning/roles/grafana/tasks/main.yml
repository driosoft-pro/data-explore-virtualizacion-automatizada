# provisioning/roles/grafana/tasks/main.yml
---
- name: Añadir clave y repo de Grafana
  apt_key:
    url: https://packages.grafana.com/gpg.key
    state: present
  become: true
- name: Añadir repositorio Grafana OSS
  apt_repository:
    repo: "deb https://packages.grafana.com/oss/deb stable main"
    state: present
  become: true
- name: Instalar Grafana
  apt:
    name: grafana
    state: present
    update_cache: true
  become: true
- name: Configurar admin_user y admin_password (opcional)
  lineinfile:
    path: /etc/grafana/grafana.ini
    regexp: "^;?admin_user ="
    line: "admin_user = {{ grafana_admin_user | default('admin') }}"
  become: true
- name: Configurar admin_password (opcional)
  lineinfile:
    path: /etc/grafana/grafana.ini
    regexp: "^;?admin_password ="
    line: "admin_password = {{ grafana_admin_password | default('admin') }}"
  become: true
- name: Asegurar Grafana habilitado y corriendo
  service:
    name: grafana-server
    state: started
    enabled: true
  become: true
# (Opcional) Provisionar datasource Prometheus automáticamente:
- name: Crear datasource Prometheus
  copy:
    dest: /etc/grafana/provisioning/datasources/prometheus.yml
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://localhost:9090
          isDefault: true
    owner: root
    group: root
    mode: "0644"
  become: true
